<?php

class Admin_jobs_model extends CI_Model
{
    public function get_jobs($job_id = null)
    {
        if ($job_id) {
            $job = $this->get_job_by_id($job_id);
            $similar_jobs = explode(',', $job['similar_jobs']);
            //exclude the self
            $this->db->where('job_id !=', $job_id);
            //exclude similar jobs
            foreach ($similar_jobs as $job) {
                $this->db->where('job_id !=', $job);
            }
        }
        $this->db->order_by('job_name');
        $query = $this->db->get('jobs');
        return $query->result('array');
    }

    public function get_job_by_id($job_id)
    {
        $this->db->where('jobs.job_id', $job_id);
        $query = $this->db->get('jobs');
        return $query->row_array();
    }

    public function update_work_hour_preferences($job_id, $querydata)
    {
        // reset all old settings
        $reset = [
            'workplace' => 0,
            'remote' => 0,
            'workdays' => 0,
            'saturday' => 0,
            'sunday' => 0,
            'bank_holidays' => 0,
            'sat_sun_bh_only' => 0,
            'normal_hours' => 0,
            'nightshift' => 0,
            'nightshift_only' => 0,
            'other_shift' => 0,
            'other_shift_only' => 0,
            'overtime' => 0
        ];
        //reset
        $this->db->where('jobs.job_id', $job_id);
        $this->db->update('jobs', $reset);
        //update
        $this->db->where('jobs.job_id', $job_id);
        if ($this->db->update('jobs', $querydata)) {
            return true;
        } else {
            return false;
        }
    }

    public function get_job_similar_jobs($job_id)
    {
        $job = $this->get_job_by_id($job_id);
        $similar_jobs = explode(',', $job['similar_jobs']);
        $this->db->where_in('jobs.job_id', $similar_jobs);
        $query = $this->db->get('jobs');
        return $query->result();
    }

    public function update_keyword($job_id, $keyword_add)
    {
        //if keyword doesn't exist in the array, then add
        $job = $this->get_job_by_id($job_id);
        $keyword_array = explode(',', $job['keywords']);
        $keywords_string = trim($job['keywords']);
        if (!in_array($keyword_add, $keyword_array, false)) {
            //if you already have a comma, skip it
            if ($keywords_string != '' && substr($keywords_string, -1) != ',') {
                $keywords_string .= ',';
            }
            $keywords_string .= $keyword_add;
            $this->db->set('keywords', $keywords_string);
            $this->db->where('jobs.job_id', $job_id);
            if ($this->db->update('jobs')) {
                return true;
            } else {
                return false;
            }
        } else {
            return false;
        }
    }
    public function update_similar_jobs($job_id, $selected_job)
    {
        //check if the id exists in the list
        $job = $this->get_job_by_id($job_id);
        if (!$this->get_job_by_id($selected_job)) {
            return false;
        } else {
            //check if this number already exist in the list
            $similar_jobs = $job[0]['similar_jobs'];
            if (!in_array($selected_job, explode(',', $similar_jobs))) {
                //if you have a trailing comma, remove it.
                $similar_jobs = ltrim($similar_jobs, ',');
                if (substr($similar_jobs, -1) != ',') {
                    $similar_jobs .= ',';
                }
                $similar_jobs .= $selected_job;
                $this->db->set('similar_jobs', $similar_jobs);
                $this->db->where('jobs.job_id', $job_id);
                if ($this->db->update('jobs')) {

                    return true;
                } else {
                    return false;
                }
            }
        }
    }
    public function remove_similar_job($job_id, $similar_job_id)
    {
        //job id is the job where the change is made, similar job is in the similar_jobs field
        $job = $this->get_job_by_id($job_id);
        $similar_jobs = explode(',', $job['similar_jobs']);
        if (($key = array_search($similar_job_id, $similar_jobs)) !== false) {
            unset($similar_jobs[$key]);
        }
        $similar_jobs = implode(',', $similar_jobs);
        $this->db->set('similar_jobs', $similar_jobs);

        $this->db->where('jobs.job_id', $job_id);
        if ($this->db->update('jobs')) {

            return true;
        } else {
            return false;
        }
    }
    public function remove_keyword($job_id, $keyword)
    {
        //job id is the job where the change is made
        $job = $this->get_job_by_id($job_id);
        $keyword_array = explode(',', $job['keywords']);
        if (($key = array_search($keyword, $keyword_array)) !== false) {
            unset($keyword_array[$key]);
        }
        $keyword_array = implode(',', $keyword_array);
        $this->db->set('keywords', $keyword_array);

        $this->db->where('jobs.job_id', $job_id);
        if ($this->db->update('jobs')) {

            return true;
        } else {
            return false;
        }
    }

    public function remove_skill($job_id, $skill_id)
    {
        //job id is the job where the change is made, skill is the joined job_requirements table

        $this->db->where('job_id', $job_id);
        $this->db->where('skill_id', $skill_id);
        if ($this->db->delete('job_requirements')) {

            return true;
        } else {
            return false;
        }
    }

    public function get_job_requirements($job_id)
    {
        $this->db->join('skills', 'job_requirements.skill_id=skills.skill_id');
        $this->db->where('job_id', $job_id);
        $this->db->order_by('skill');
        $query = $this->db->get('job_requirements');
        return $query->result('array');
    }

    public function exclude_items($exclude_array)
    {
        if ($exclude_array) {
            $this->db->where_not_in('skill_id', $exclude_array);
        }
        $this->db->order_by('skill');
        $query = $this->db->get('skills');
        return $query->result();
    }

    public function exclude_license_items($exclude_array)
    {
        if ($exclude_array) {
            $this->db->where_not_in('driving_id', $exclude_array);
        }
        $query = $this->db->get('drivers');
        return $query->result();
    }

    public function store_skill($job_id, $skill_id)
    {
        $data = [
            'job_id' => $job_id,
            'skill_id' => $skill_id,
        ];

        if ($this->db->insert('job_requirements', $data)) {
            return true;
        } else {
            return false;
        }
    }
    public function add_job($job)
    {
        //change first letter to uppercase

        $data = [
            'job_name' => ucfirst($job),
            'remote' => 0,
            'overtime' => 0,
            'nightshift' => 0,
            'other_shift' => 0,
            'workdays' => 0,
            'saturday' => 0,
            'sunday' => 0,
            'bank_holidays' => 0
        ];

        if ($this->db->insert('jobs', $data)) {
            //set drivers license to default
            $insert_id = $this->db->insert_id();
            $this->add_license($insert_id, 1);

            return $insert_id;
        } else {
            return false;
        }
    }
    public function get_jobs_drivers_licenses($job_id, $driving_id = null)
    {
        $this->db->join('drivers', 'drivers.driving_id=job_drivers_licenses.driving_id');
        if ($driving_id) {
            $this->db->where('job_drivers_licenses.driving_id', $driving_id);
        }
        $this->db->where('job_id', $job_id);
        $query = $this->db->get('job_drivers_licenses');
        return $query->result('array');
    }

    public function remove_license($job_id, $driving_id = null)
    {

        //check if they want to delete all
        $this->db->where('job_id', $job_id);
        if ($driving_id) {
            $this->db->where('driving_id', $driving_id);
        }
        if (!$this->db->delete('job_drivers_licenses')) {
            return false;
        } else {
            $this->db->where('job_id', $job_id);
            $query = $this->db->get('job_drivers_licenses');
            $result_array = $query->result('array');
            if (!$result_array) {
                //reset to none
                $querydata = [
                    'job_id' =>$job_id,
                    'driving_id' => 1,
                ];
                $this->db->insert('job_drivers_licenses',$querydata);
                return true;
            }
        }
    }

    public function remove_license_none($job_id, $driving_id = null)
    {

        $this->db->where('job_id', $job_id);
        if ($driving_id) {
            $this->db->where('driving_id', $driving_id);
        }
        if ($this->db->delete('job_drivers_licenses')) {
            return true;
        } else {
            return false;
        }
    }

    public function add_license($job_id, $driving_id, $driving_years = 0)
    {
        //TODO add must, years and clean

        $querydata =
            [
                'job_id' => $job_id,
                'driving_id' => $driving_id,
                'years' => $driving_years
            ];
        if ($this->db->insert('job_drivers_licenses', $querydata)) {
            return true;
        } else {
            return false;
        }
    }
}
