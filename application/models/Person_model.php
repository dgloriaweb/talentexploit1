<?php

class Person_model extends CI_Model
{

    public function register($enc_password)
    {
        //user data array
        $data = [
            'username' => htmlentities($this->input->post('username')),
            'password' => $enc_password,

        ];

        $this->db->insert('persons', $data);
        $insert_id = $this->db->insert_id();
        // insert none into drivers licenses
        $licensedata = [

        ] ;
        return $insert_id;
    }

    public function login($username)
    {
        $this->db->where('username', $username);
        $result = $this->db->get('persons');
        if ($result->num_rows() == 1) {
            return $result->row(0);
        } else {
            return false;
        }
    }
    public function check_username_exists($username)
    {
        $query = $this->db->get_where('persons', ['username' => $username]);
        if (empty($query->row_array())) {
            return true;
        } else {
            return false;
        }
    }

    public function get_person_properties($person_id, $prop_link_type, $sub_join_table, $join, $main_join_table, $main_join_fields, $where_field)
    {
        //SELECT * FROM `persons` left join properties on persons.person_id = properties.person_id where persons.person_id = 5 and properties.prop_link_type ='language'
        // $this->db->select('username,prop_link_id,prop_link_type,driving_years,langlevel_id,sector_years');
        //SELECT * FROM `persons` left join properties on persons.person_id = properties.person_id left join languages on properties.prop_link_id = languages.language_id left join language_levels on properties.langlevel_id = language_levels.langlevel_id where persons.person_id = 5 and properties.prop_link_type ='language'
        $this->db->select('*');
        // $this->db->join('properties', 'persons.person_id = properties.person_id');
        $this->db->join($main_join_table, $main_join_fields);
        $this->db->join($sub_join_table, $join);
        $this->db->where('persons.person_id', $person_id);
        // $this->db->where('properties.prop_link_type',$prop_link_type);
        $this->db->where($where_field, $prop_link_type);
        $this->db->order_by($prop_link_type);
        $query = $this->db->get('persons');
        return $query->result();

    }

    public function get_person_languages($main_join_table, $person_id)
    {
        //SELECT * FROM `persons`
        //left join properties on persons.person_id = properties.person_id
        //left join languages on properties.prop_link_id = languages.language_id
        //left join language_levels on properties.langlevel_id = language_levels.langlevel_id
        //where persons.person_id = 5 and properties.prop_link_type ='language'
        $this->db->select('*');
        $this->db->join($main_join_table, 'persons.person_id = ' . $main_join_table . '.person_id');
        $this->db->join('languages', $main_join_table . '.prop_link_id = languages.language_id');
        $this->db->join('language_levels', $main_join_table . '.langlevel_id = language_levels.langlevel_id');
        $this->db->where('persons.person_id', $person_id);
        $this->db->where($main_join_table . '.prop_link_type', 'language');
        $this->db->order_by($main_join_table . '.prop_link_type');
        $query = $this->db->get('persons');
        return $query->result();

    }
    public function check_if_admin($person_id)
    {
        $this->db->select('is_admin');
        $this->db->where('person_id', $person_id);
        $query = $this->db->get('persons');
        if ($query->result()[0]->is_admin == 1) {
            return true;
        } else {
            return false;
        }
    }

    /**
     * fill in data on dashboard and edit page for work hour preferences
     *
     * @param [type] $person_id
     * @return void
     */
    public function get_persons_work_details($person_id)
    {
        $this->db->select('overtime,nightshift,other_shift,weekdays,saturday,sunday,bank_holidays');
        $this->db->where('person_id', $person_id);
        $query = $this->db->get('persons');
        return $query->result();

    }

    public function update_work_hour_preferences($data)
    {
        $query_array = 
        [
            'overtime' =>$data['overtime'],
            'nightshift' =>$data['nightshift'],
            'other_shift' => $data['other_shift'],
            'weekdays' => $data['weekdays'],
            'saturday' => $data['saturday'],
            'sunday' => $data['sunday'],
            'bank_holidays' => $data['bank_holidays'],
        ];
        $this->db->where('person_id', $data['person_id']);
        if ($this->db->update('persons',$query_array)) {
            return true;
        } else {
            return false;
        }

    }
}
