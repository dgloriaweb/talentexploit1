<?php
defined('BASEPATH') or exit('No direct script access allowed');

class Citizenships extends CI_Controller
{
    public function __construct()
    {
        parent::__construct();
        if (!$this->session->userdata('logged_in') && $this->uri->segment(1, '') !== 'register' && $this->uri->segment(2, '') !== 'store_user') {
            redirect('login');
        }
    }
    public function add()
    {
        $this->form_validation->set_error_delimiters('<div class="alert alert-danger">', '</div>');
        $data['title'] = 'Add citizenship';
        $person_id = $this->session->userdata('person_id');
        $this->form_validation->set_rules('cit_selection', 'cit_selection', 'required|callback_check_citizenship_exists');
        
        if ($this->form_validation->run()) {
            $new_property = [
                'person_id' => $person_id,
                'prop_link_id' => $this->input->post('cit_selection'), 
                'prop_link_type' => 'citizenship'
    
            ];
             if (!$this->properties_model->add($new_property)) {
                //set message
                $this->session->set_flashdata('citizenship_not_added', 'New citizenship NOT added');
                redirect('persons/citizenships');
            } else {
                //set message
                $this->session->set_flashdata('citizenship_added', 'New license added');
                redirect('persons/citizenships');
            }
        } else {
            $this->load->view('citizenships_view', $data);
        }
    }

    public function exclude_existing_items()
    {
        $person_id = $this->input->post('id');
        $available_items = $this->citizenships_model->exclude_items($person_id);
        echo json_encode($available_items);
        exit();

    }

    /**
     * validate select dropdown received value
     *
     * @return void
     */
    public function check_citizenship_exists()
    {
        $this->form_validation->set_message('check_citizenship_exists', 'That citizenship doesn\'t exist, please choose from the list.');
        if ($this->citizenships_model->check_citizenship_exists($this->input->post('cit_selection'))) {
            return true;
        } else {
            return false;
        }
    }

}