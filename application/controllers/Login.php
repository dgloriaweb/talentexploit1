<?php
defined('BASEPATH') or exit('No direct script access allowed');

class Login extends CI_Controller
{ 
    
   public function index()
    {
       $data['title'] = 'Log In';
       $this->load->view('login_view', $data);

   }
   public function process()
   {
       $data['title'] = 'Log In';
       $this->form_validation->set_rules('username', 'Username', 'required');
       $this->form_validation->set_rules('password', 'Password', 'required');
       if ($this->form_validation->run()) {
           $password = htmlentities($this->input->post('password'));
           $username = htmlentities($this->input->post('username'));
           $dbpassword = $this->person_model->login($username);
           if ($dbpassword) {
               //if we get result, assert password hash
               if (password_verify($password, $dbpassword)) {
                   //create session
                   $user_data = [
                       'username' => $username,
                       'logged_in' => true,
                   ];
                   $this->session->set_userdata($user_data);
                   //show success message
                   $this->session->set_flashdata('user_logged_in', 'You are now logged in');
                   redirect('persons');
               } else {
                   //password doesn't match
                   $this->session->set_flashdata('login_failed', 'password doesn\'t match');
                   redirect('login');
               }
           } else {
               //username not found in database
               $this->session->set_flashdata('login_failed', 'username doesn\'t exist');
               redirect('login');
           }
       } else {
           $this->load->view('login_view', $data);
       }
   }
}