<?php
defined('BASEPATH') or exit('No direct script access allowed');

class Admin_sectors extends CI_Controller
{
    //create a place to handle edit and connect sectors, core sectors, jobs and all that's required
    public function __construct()
    {
        parent::__construct();
        if (!$this->session->userdata('logged_in') && $this->uri->segment(1, '') !== 'register' && $this->uri->segment(2, '') !== 'store_user') {
            redirect('login');
        }
        if (!$this->session->userdata('is_admin')) {
            redirect('login');
        }
    }

    public function index()
    {
        $data['title'] = 'Sectors';
        $data['sectors'] = $this->sectors_model->get_sectors();
        $this->load->view('admin_sectors_view', $data);
    }

    public function get_sectors()
    {
        $sector_id = $this->uri->segment(3, 0);
        $sectors = $this->sectors_model->get_sectors($sector_id);
        if (isset($sectors)) {
            echo json_encode($sectors[0]);
            exit();

        }
    }

    public function edit()
    {
        $sector_id = $this->uri->segment(3, 0);
        //show edit sector page
        $data['title'] = 'Edit sector';
        $data['sector_data'] = $this->sectors_model->get_sectors($sector_id);
        $this->load->view('admin_sector_edit_view', $data);
    }

    public function update_sector()
    {
        $newsector = htmlentities($this->input->post('sector_input'));
        $sector_id = htmlentities($this->input->post('sector_id'));
        //update database here, use validation!
        //add message about change
        if (!$this->sectors_model->update_sector($sector_id, $newsector)) {
            //error
            $this->session->set_flashdata('sector_exists', 'sector already exists');
            redirect('admin_sectors/edit_sector/' . $sector_id);

        } else {
            $this->session->set_flashdata('sector_edited', 'sector edited successfully');
            redirect('admin_sectors');
        }
    }

    public function add_sector()
    {
        $newsector = htmlentities($this->input->post('sector_input'));
        if (!$this->sectors_model->add_sector($newsector)) {
            //error
            $this->session->set_flashdata('sector_not_created', 'sector NOT created');
        } else {
            $this->session->set_flashdata('sector_created', 'sector created successfully');
        }
        redirect('admin_sectors');

    }
}
