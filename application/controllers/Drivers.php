<?php
defined('BASEPATH') or exit('No direct script access allowed');

class Drivers extends CI_Controller
{
    public $person_id;
    public $main_join_table;

    public function __construct()
    {
        parent::__construct();
        if (!$this->session->userdata('logged_in') && $this->uri->segment(1, '') !== 'register' && $this->uri->segment(2, '') !== 'store_user') {
            redirect('login');
        }
        $this->person_id = $this->session->userdata('person_id');
        $this->main_join_table = 'properties';
        if ($this->uri->segment(3, 0) == 'desire') {
            $this->main_join_table = 'desired_job_links';
        }
        $this->maintitle = 'TalentExploit - ';
    }

    public function submit_added_drivers_license($controller = NULL, $id = NULL)
    {
        //route each drivers license change to it's corresponding add function
        if ($controller == 'admin_jobs') {
            //id here is job id
            $this->add_license_job( $id);
        } else if ($controller == 'persons') {
            //id here is person_id
            $this->add_license_person_property($controller, $id);
        }
    }

    public function add_license_person_property($controller = NULL, $id = NULL)
    {
        //if detail is passed set join to properties
        //if desired is passed, set join to desired_job_links
        $main_join_fields = 'persons.person_id = properties.person_id';
        $where_field = 'properties.prop_link_type';
        $main_join_table = 'properties';
        if ($controller == 'desire') {
            $main_join_fields = 'persons.person_id = desired_job_links.person_id';
            $where_field = 'desired_job_links.prop_link_type';
            $main_join_table = 'desired_job_links';
        }

        //if the selected is 'none', check if anything is selected already
        //if anything is selected ask if all else can be deleted?
        //check how missing driving years affects other parts of the program

        $this->form_validation->set_error_delimiters('<div class="alert alert-danger">', '</div>');
        $data['title'] = 'Add license';
        $data['person_licenses'] = $this->person_model->get_person_properties($this->person_id, 'drivers_license', 'drivers', $main_join_table . '.prop_link_id = drivers.driving_id', $main_join_table, $main_join_fields, $where_field);
        $driving_years = intval($this->input->post('driving_years'));
        $this->form_validation->set_rules('license_selection', 'license_selection', 'required|callback_check_type_exists');
        //set validation for selection
        $this->form_validation->set_rules('driving_years', 'driving_years', 'required|callback_check_number_range');

        //if 'none' is selected accept selection without driving years field validation
        if ($this->form_validation->run()) {
            if (htmlspecialchars($this->input->post('license_selection')) != 1) {
                //check if 'none' has been already selected and if yes, remove it.
                //use get_links, send data: `person_id` = person_id AND `prop_link_id` = 1 AND `prop_link_type` = 'drivers_license'
                $querydata = [
                    'person_id' => $this->person_id,
                    'prop_link_id' => 1,
                    'prop_link_type' => 'drivers_license',
                ];
                $link_to_none_exists = $this->properties_model->get_links($main_join_table, $querydata);
                if ($link_to_none_exists) {
                    //if it returns a row, delete that row by properties_id
                    $prop_id = $link_to_none_exists[0]->prop_id;
                    $this->properties_model->delete_link_by_id($main_join_table, $prop_id);
                }
            } else {
                // if none is selected and user has any links ask if user wants to delete all existing links
                $querydata = [
                    'person_id' => $this->person_id,
                    'prop_link_type' => 'drivers_license',
                ];
                $drivers_license_links = $this->properties_model->get_links($main_join_table, $querydata);
                if ($drivers_license_links) {
                    //TODO: alert user that all is going to be deleted
                    foreach ($drivers_license_links as $drivers_license_link) {
                        $prop_id = $drivers_license_link->prop_id;
                        $this->properties_model->delete_link_by_id($main_join_table, $prop_id);
                    }
                }

                //if 'none' is selected, reset driving_years field, this can be removed later when javascript runs
                $driving_years = 0;
            }
            //get driving_id from the drivers license code
            $querydata = [
                'person_id' => $this->person_id,
                //we have license type, we don't have the id, check if we do, we need the driving_id
                'prop_link_id' => htmlspecialchars($this->input->post('license_selection')),
                'driving_years' => htmlspecialchars($driving_years),
                'prop_link_type' => 'drivers_license',
            ];

            //this has to be stored in the person_links table
            if (!$this->properties_model->add($main_join_table, $querydata)) {
                //set message
                $this->session->set_flashdata('license_not_added', 'New license NOT added');
            } else {
                //set message
                $this->session->set_flashdata('license_added', 'New license added');
            }
        } else {
            $this->session->set_flashdata('license_not_added', 'New license NOT added');
        }
        redirect('persons/show_user_settings');
    }

    public function add_license_job( $id)
    {
        $data['title'] = 'Edit job';
        $job_id =  $id;
        $driving_id = htmlspecialchars($this->input->post('license_selection'));
        $driving_years = htmlspecialchars($this->input->post('driving_years'));
        $this->form_validation->set_rules('license_selection', 'license_selection', 'required|callback_check_type_exists');
        if ($driving_id != 1) {
            $this->form_validation->set_rules('driving_years', 'driving_years', 'required|callback_check_number_range');
        } else {
            //if 'none' is selected, no need to set years
            $driving_years = null;
        }
        //if 'none' is selected accept selection
        if ($driving_id != 1) {
            //check if 'none' has been already selected and if yes, remove it.
            $licenses = $this->admin_jobs_model->get_jobs_drivers_licenses($job_id);
            if ($licenses[0]['driving_id'] == 1) {
                $this->admin_jobs_model->delete_license_none($job_id);
            }
        } else {
            // if none is selected and user has any links ask if user wants to delete all existing links
            $this->admin_jobs_model->delete_license($job_id);
        }
        if ($this->form_validation->run()) {
            //do add bit
            if (!$this->admin_jobs_model->add_license($job_id, $driving_id, $driving_years)) {
                //set message
                $this->session->set_flashdata('license_not_added', 'New license NOT added');
            } else {
                //set message
                $this->session->set_flashdata('license_added', 'New license added');
            }
        } else {
            $this->session->set_flashdata('license_not_added', 'New license NOT added');
        }

        redirect('admin_jobs/edit_job/' . $job_id);
    }


    /**
     * validate dropdown if selection is not forged
     *
     * @return void
     */
    public function check_type_exists()
    {
        $this->form_validation->set_message('check_type_exists', 'That type doesn\'t exist, please choose from the list.');
        if ($this->global_model->check_type_exists(htmlspecialchars($this->input->post('license_selection')), 'driving_id', 'drivers')) {
            return true;
        } else {
            return false;
        }
    }

    /**
     * validate the entered value if it is acceptable
     *
     * @return void
     */
    public function check_number_range()
    {
        $driving_years = intval($this->input->post('driving_years'));
        $this->form_validation->set_message('check_number_range', 'Please set years between 1 and 90.');
        if ($driving_years > 0 && $driving_years < 90) {
            return true;
        } else {
            return false;
        }
    }

    public function submit_deleted_drivers_license($controller, $id = NULL, $driving_id = NULL)
    {
        //route each drivers license change to it's corresponding add function
        if ($controller == 'admin_jobs') {
            //id here is job id
            $this->delete_license_from_job($id, $driving_id);
        } else if ($controller == 'persons') {
            //id here is person_id
            $this->delete_license_from_person_property($id, $driving_id);
        }
    }

    /**
     * Retracted delete method from all details page and included here for saving space
     *
     * @return void
     */
    public function delete_license_from_person_property($id, $driving_id)
    {
        //watch out, here the 'desire is the 5th segment!
        // get prop_id
        $querydata = [
            'person_id' => $id,
            'prop_link_id' => $driving_id,
            'prop_link_type' => 'drivers_license',
        ];
        $prop_id = $this->properties_model->get_links($this->main_join_table, $querydata)[0]->prop_id;
        //delete this record from the links table
        if (!$this->properties_model->delete_license_by_id($this->main_join_table, $prop_id,$id)) {
            //error
            $this->session->set_flashdata('link_cannot_be_deleted', 'Error deleting link');
        } else {
            $this->session->set_flashdata('link_removed', 'Item removed successfully');
        }
        redirect('persons/show_user_settings');
    }

    public function delete_license_from_job($job_id = NULL, $driving_id = NULL)
    {
        if (!$this->admin_jobs_model->delete_license($job_id, $driving_id)) {
            //set message
            $this->session->set_flashdata('license_not_deleted', 'New license NOT deleted');
        } else {
            //set message
            $this->session->set_flashdata('license_deleted', 'New license deleted');
        }
        redirect('admin_jobs/edit_job/' . $job_id);
    }
}
