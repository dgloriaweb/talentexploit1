<?php
defined('BASEPATH') or exit('No direct script access allowed');

class Admin_drivers_licenses extends CI_Controller
{
    public function __construct()
    {
        parent::__construct();
        if (!$this->session->userdata('logged_in') && $this->uri->segment(1, '') !== 'register' && $this->uri->segment(2, '') !== 'store_user') {
            redirect('login');
        }
        if (!$this->session->userdata('is_admin')) {
            redirect('login');
        }
    }

    public function index()
    {
        $data['title'] = 'Drivers\' licenses';
        $data['drivers_licenses'] = $this->drivers_model->get_license_types();
        $this->load->view('admin_licenses_view', $data);
    }

    public function get_licenses()
    {
        $drivers_licenses = $this->drivers_model->get_license_types($this->input->post('id'));
        echo json_encode($drivers_licenses[0]);
        exit();
    }

    public function update_license()
    {
        $newlicense = htmlentities($this->input->post('license_input'));
        $driving_id = htmlentities($this->input->post('driving_id'));
        //update database here, use validation!
        //add message about change
        if (!$this->drivers_model->update_license($driving_id, $newlicense)) {
            //error
            $this->session->set_flashdata('license_exists', 'license already exists');
            redirect('admin_drivers_licenses/edit_license/' . $driving_id);

        } else {
            $this->session->set_flashdata('license_edited', 'license edited successfully');
            redirect('admin_drivers_licenses');
        }

    }

    public function add_license()
    {
        $newlicense = htmlentities($this->input->post('license_input'));
        if (!$this->drivers_model->add_license($newlicense)) {
            //error
            $this->session->set_flashdata('admin_license_not_added', 'license already exists');
        } else {
            $this->session->set_flashdata('admin_license_added', 'license edited successfully');
        }
        redirect('admin_drivers_licenses');
    }
}
